@using System.IO
@model ProductVM

<div class="card mt-4 mb-5">
    <div class="card-header bg-secondary bg-gradient text-white py-3">
        <h2 class="text-white mb-0 text-center">@(Model.Product.Id == 0 ? "Create" : "Edit") Product</h2>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            <div asp-validation-summary="All" class="text-danger"></div>
            <input asp-for="Product.Id" hidden />
            <input asp-for="Product.ImageUrl" hidden />
            <input type="file" id="mainImageUpload" name="file" style="display:none;" accept="image/*" onchange="previewMainImage(this)" />
            <div class="row">
                <div class="col-md-10">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Product.Title" class="form-label"></label>
                                <input asp-for="Product.Title" type="text" class="form-control" />
                                <span asp-validation-for="Product.Title" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.Description" class="form-label"></label>
                                <textarea asp-for="Product.Description" class="form-control"></textarea>
                                <span asp-validation-for="Product.Description" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.ISBN" class="form-label"></label>
                                <input asp-for="Product.ISBN" type="text" class="form-control" />
                                <span asp-validation-for="Product.ISBN" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.Author" class="form-label"></label>
                                <input asp-for="Product.Author" type="text" class="form-control" />
                                <span asp-validation-for="Product.Author" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.CategoryId" class="form-label"></label>
                                <select asp-for="Product.CategoryId" asp-items="@Model.CategoryList" class="form-select">
                                    <option value="0" disabled selected>--Select Category--</option>
                                </select>
                                <span asp-validation-for="Product.CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Product.ListPrice" class="form-label"></label>
                                <input asp-for="Product.ListPrice" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="Product.ListPrice" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.Price" class="form-label"></label>
                                <input asp-for="Product.Price" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="Product.Price" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.Price50" class="form-label"></label>
                                <input asp-for="Product.Price50" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="Product.Price50" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Product.Price100" class="form-label"></label>
                                <input asp-for="Product.Price100" type="number" step="0.01" class="form-control" />
                                <span asp-validation-for="Product.Price100" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    @if (Model.Product.Id != 0 && Model.Product.ProductImages != null && Model.Product.ProductImages.Any())
                    {
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>Existing Images</h5>
                                <div class="row" id="existingImagesContainer">
                                    @foreach (var image in Model.Product.ProductImages)
                                    {
                                        <div class="col-md-2 col-sm-3 col-4 mb-3 position-relative image-container" data-image-id="@image.Id">
                                            <img src="@image.ImageUrl" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;" />
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                    onclick="deleteImage(@image.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Upload Additional Images (Multiple)</label>
                                <input type="file" id="uploadBox" name="files" class="form-control" multiple accept="image/*" onchange="previewImages(this)" />
                                <small class="text-muted">You can select multiple images to add to the gallery</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>New Images Preview</h5>
                            <div class="row" id="imagePreviewContainer"></div>
                        </div>
                    </div>

                    <div class="row mt-3 mb-4">
                        <div class="col-6 col-md-3">
                            <button type="submit" class="btn btn-primary form-control">
                                @(Model.Product.Id == 0 ? "Create" : "Update")
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <a asp-controller="Product" asp-action="Index" class="btn border form-control">
                                Back to List
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center mb-2">
                        <label class="form-label fw-bold">Main Image</label>
                        <small class="d-block text-muted">Click to change</small>
                    </div>
                    <div id="mainImageContainer" onclick="document.getElementById('mainImageUpload').click();" 
                         style="cursor: pointer; position: relative;">
                        @if (!string.IsNullOrEmpty(Model.Product.ImageUrl))
                        {
                            <img id="mainImagePreview" src="@Model.Product.ImageUrl" class="img-fluid" 
                                 style="max-width: 100%; border-radius: 5px; border: 2px solid #007bff;" />
                            <div class="position-absolute top-50 start-50 translate-middle" 
                                 style="display: none; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;"
                                 id="mainImageHoverOverlay">
                                <i class="bi bi-camera text-white" style="font-size: 2rem;"></i>
                            </div>
                        }
                        else
                        {
                            <div id="mainImagePlaceholder" style="padding: 20px; background-color: #f8f9fa; border-radius: 5px; border: 2px dashed #007bff; text-align: center;">
                                <i class="bi bi-camera" style="font-size: 3rem; color: #007bff;"></i>
                                <p class="mt-2 text-muted">Click to upload<br/>main image</p>
                            </div>
                        }
                    </div>
                    <small class="d-block text-center mt-2 text-primary">
                        <i class="bi bi-star-fill"></i> Primary Display
                    </small>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.tiny.cloud/1/5yawfz9vtdd1q8y96mvd3ip1mrhecbk99ya8ff3enftl01st/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
    <script>
        tinymce.init({
            selector: 'textarea',
            plugins: 'lists link image table code help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help'
        });

        // Hover effect for main image
        document.getElementById('mainImageContainer')?.addEventListener('mouseenter', function() {
            const overlay = document.getElementById('mainImageHoverOverlay');
            if (overlay) {
                overlay.style.display = 'block';
            }
        });

        document.getElementById('mainImageContainer')?.addEventListener('mouseleave', function() {
            const overlay = document.getElementById('mainImageHoverOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        });

        function previewMainImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    const container = document.getElementById('mainImageContainer');
                    const placeholder = document.getElementById('mainImagePlaceholder');
                    
                    if (placeholder) {
                        placeholder.remove();
                    }

                    let img = document.getElementById('mainImagePreview');
                    if (!img) {
                        img = document.createElement('img');
                        img.id = 'mainImagePreview';
                        img.className = 'img-fluid';
                        img.style.cssText = 'max-width: 100%; border-radius: 5px; border: 2px solid #007bff;';
                        
                        const overlay = document.createElement('div');
                        overlay.id = 'mainImageHoverOverlay';
                        overlay.className = 'position-absolute top-50 start-50 translate-middle';
                        overlay.style.cssText = 'display: none; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;';
                        overlay.innerHTML = '<i class="bi bi-camera text-white" style="font-size: 2rem;"></i>';
                        
                        container.appendChild(img);
                        container.appendChild(overlay);
                    }
                    
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewImages(input) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            if (input.files) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'col-md-2 col-sm-3 col-4 mb-3';
                        colDiv.innerHTML = `
                            <div class="position-relative">
                                <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;" />
                                <span class="badge bg-primary position-absolute top-0 start-0 m-1">${index + 1}</span>
                            </div>
                        `;
                        container.appendChild(colDiv);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function deleteImage(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            fetch(`/Admin/Product/DeleteImage?imageId=${imageId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-image-id="${imageId}"]`).remove();
                    toastr.success(data.message);
                } else {
                    toastr.error(data.message);
                }
            })
            .catch(error => {
                toastr.error('Error deleting image');
                console.error('Error:', error);
            });
        }
    </script>
    <partial name="_ValidationScriptsPartial" />
}
